from urllib.parse import urljoin
from aiohttp import ClientSession

from pinkerton.base import EntityType
from pinkerton.settings import DATA_PROVIDER_CLIENT_HEADERS


class EntityExtractor:

    '''
    Provides API to Natasha playground
    '''

    ENTITIES_CONVERT_MAP = {
        'person': EntityType.Person,
        'organisation': EntityType.Organisation,
        'location': EntityType.Location,
        'street': EntityType.Location,
        'address': EntityType.Address,
    }

    def __init__(self, api_base_url: str):
        self.api_base_url = api_base_url
        self.api_extract_url = urljoin(self.api_base_url, 'extract')
        self.api_version_url = urljoin(self.api_base_url, 'version')

    @property
    def session(self):
        return ClientSession(headers=DATA_PROVIDER_CLIENT_HEADERS)

    async def extract(self, text: str) -> (list, list):
        '''
        Returns two lists: with extracted objects (\w solved coreference)
        and a list with extracted spans (with raw morphological info)
        '''
        async with self.session as session:
            async with session.post(self.api_extract_url, data={
                'text': text,
            }) as response:
                response = await response.json()
                objects, spans = response['objects'], response['spans']

                for obj in objects:
                    obj['type'] = self.ENTITIES_CONVERT_MAP[obj['type']]

                return objects, spans
